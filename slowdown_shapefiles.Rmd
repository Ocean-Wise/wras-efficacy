---
title: "Slowdown shapefiles"
author: "Alex Mitchell"
date: "2023-05-15"
output: 
  rmdformats::downcute:
    downcute_theme: "chaos"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(magrittr)
user <- "AlexMitchell"
```

## What is this script for?

To import and process the shapefiles for slowdown areas run by the ECHO Programme (BC) and Quiet Sound (WA). 

I was having issues with the shapefiles as they are not closed multiline or multipolygons/polygons so I would be unable to test whether a point fell inside of the borders. I needed to transform the open multiline objects into closed polygons and merge together based on the years.

My plan is to extract multiline objects from the Slowdown2022 object, convert multiline to polygons to close, and then merge.

## Swiftsure

### Details

- 2018 - 2021: On the Outbound Slowdown Zone
- 2021 onwards: Outbound and Inbound Slowdown zone

### Load Data
```{r}
slowdown2022 <- sf::read_sf(dsn = paste0("C:/Users/",
                            user,
                            "/Ocean Wise Conservation Association/Whales Initiative - General/OceanWise Data/Shapefiles/2022 Slowdown/"), layer = "Slowdown") %>% 
  sf::st_transform(., crs = 4326) %>% 
  sf::st_zm(., drop = T) ## The shapefile is coded with a Z dimension, albeit being 0, which we have to remove before plotting 
```

### Splitting the data

The shapefile contains 3 multiline objects (`Overlap`, `Inbound`, `Outbound`), I split these up as two are closed, one is not.

```{r}
overlap <- slowdown2022 %>% 
  dplyr::filter(Name == "Swiftsure Overlap") %>% 
  sf::st_cast(., "POLYGON") %>% 
  dplyr::select(geometry)

inbound <- slowdown2022 %>% 
  dplyr::filter(Name == "Swiftsure Inbound") %>% 
  sf::st_cast(., "MULTIPOLYGON") %>% 
  dplyr::select(geometry)

outbound_messy <- slowdown2022 %>% 
  dplyr::filter(Name == "Swiftsure Outbound")
```

### Cleaning the `outbound` shape

There are two multiline objects within one shape, I needed to split these and create a boundry box (`cocaveman`) around the multiline object which creates a closed polygon object. 

Initally, trying to convert the multiline object into a polygon led to end points of the object being joined in the wrong order. Rather than editing the points in the object it was easier to take all of the points and create a bounding box with 0 margin around the object.

I then union them together based on 

```{r warning = F, message = F}
outbound1 <- outbound_messy %>% 
  .[1,] %>% 
  sf::st_cast(., "POINT") %>% 
  concaveman::concaveman(.)

outbound2 <- outbound_messy %>% 
  .[2,] %>% 
  sf::st_cast(., "POINT") %>% 
  concaveman::concaveman(.) 

slowdown_pre_2021 <- sf::st_union(outbound1, outbound2) %>% 
  sf::st_union(overlap) 

slowdown_post_2021 <- sf::st_union(outbound1, outbound2) %>% 
  sf::st_union(inbound) %>%
  sf::st_union(overlap)
```


## Haro Strait & Boundry Pass

### Details

- 2017 Onwards

### Load Data

```{r}
slowdown2022_haro <- sf::read_sf(dsn = "../../OWSN/2022 HaroSlowdown/", 
                                 layer = "HaroSlowdown")
```

### Clean Data
```{r}
slowdown2022_haro <- slowdown2022_haro %>% 
  sf::st_transform(., crs = 4326) %>% 
  sf::st_cast(., "POLYGON") %>%
  sf::st_zm(., drop = T) %>%  ## Drop the z dimension as there is none
  dplyr::select(geometry) ## No additional information is needed for the 
```

## Plot

Check that the maps match the expected outcome

### 2017 - 2018
```{r, figures-side}
leaflet::leaflet() %>% 
  leaflet::addTiles() %>% 
  leaflet::addPolygons(data = slowdown2022_haro)
```

### 2018 to 2021
```{r}
leaflet::leaflet() %>% 
  leaflet::addTiles() %>% 
  leaflet::addPolygons(data = slowdown2022_haro) %>% 
  leaflet::addPolygons(data = slowdown_pre_2021)
```

### 2021 to now
```{r}
leaflet::leaflet() %>% 
  leaflet::addTiles() %>% 
  leaflet::addPolygons(data = slowdown2022_haro) %>% 
  leaflet::addPolygons(data = slowdown_pre_2021) %>% 
  leaflet::addPolygons(data = slowdown_post_2021)
```


## Export shapefiles

Export as RData file as these files will only be used in R. If they are needed elsewhere I can convert to .shp.

```{r}
slowdown2017 = slowdown2022_haro
saveRDS(slowdown2017, "./shapefiles/processed/slowdown2017.rds")

slowdown2018_2021 = slowdown2017 %>% 
  sf::st_union(., slowdown_pre_2021)
saveRDS(slowdown2018_2021, "./shapefiles/processed/slowdown2018_2021.rds")

slowdown2021 = slowdown2017 %>% 
  sf::st_union(., slowdown_post_2021)
saveRDS(slowdown2021, "./shapefiles/processed/slowdown2021.rds")

```

